dist: xenial

services: docker

language: bash

env:
  global:
    - TEST_SCRIPT="python -m unittest discover" # Runs all test_*.py files
    - DOCKER_TAG=$DOCKER_USERNAME/travis-testing:1.0.1-testing1.0  

jobs:
  include:
    - stage: python-version-tests
      python: "3.7"
      script: $TEST_SCRIPT
    - # parallel job in python-version-tests stage
      python: "3.8"
      script: $TEST_SCRIPT

    - stage: container-tests
      script:
        - docker pull python:3.6.9-alpine3.9
        - docker build -t my-calc .
        - docker run --rm my-calc $TEST_SCRIPT

    - stage: deploy-to-docker
      script:
        - docker pull python:3.6.9-alpine3.9
        - docker build -t $DOCKER_TAG .
        - echo $DOCKER_PASSWORD | docker login -u="$DOCKER_USERNAME" --password-stdin 
        - docker push $DOCKER_TAG

stages:
  - python-version-tests
  - container-tests
  - deploy
   
notifications:
    email: false